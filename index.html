<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Control Ventas Multisucursal</title>
<style>
  /* Reset */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  body {
    background: #000;
    color: #ff2d8f;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    font-weight: 600;
  }
  h1, h2, h3 {
    color: #ff2d8f;
    margin-bottom: 1rem;
  }
  .container {
    width: 90%;
    max-width: 1000px;
    margin: 2rem auto;
    background: #111;
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 0 10px #ff2d8faa;
  }
  input, select, button, textarea {
    font-size: 1rem;
    margin: 0.3rem 0;
    padding: 0.5rem;
    border-radius: 6px;
    border: none;
    outline: none;
    font-weight: 600;
    background: #222;
    color: #ff2d8f;
    box-shadow: 0 0 8px #ff2d8f99;
    transition: 0.3s;
  }
  input:focus, select:focus, textarea:focus {
    box-shadow: 0 0 12px #ff2d8fff;
  }
  button {
    cursor: pointer;
    background: #ff2d8f;
    color: #000;
    font-weight: 700;
    border-radius: 12px;
    transition: background 0.3s;
  }
  button:hover {
    background: #ff1a6b;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    box-shadow: 0 0 8px #ff2d8f88;
  }
  th, td {
    border: 1px solid #ff2d8f44;
    padding: 0.5rem;
    text-align: left;
  }
  thead {
    background: #ff2d8f22;
    color: #ff2d8f;
  }
  nav {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  nav button {
    background: #ff2d8f;
    border-radius: 12px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    color: #000;
    border: none;
    cursor: pointer;
    transition: 0.3s;
  }
  nav button:hover {
    background: #ff1a6b;
  }
  #loginSection, #adminSection, #employeeSection {
    display: none;
  }
  #loginSection.active, #adminSection.active, #employeeSection.active {
    display: block;
  }
  .msg {
    margin-top: 0.5rem;
    font-weight: 600;
    color: #ff6fa1;
  }
  .hidden {
    display: none !important;
  }
  textarea {
    resize: vertical;
  }
  /* Ticket */
  #ticketSection {
    display: none;
    margin-top: 1rem;
    background: #111;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 0 10px #ff2d8faa;
    max-width: 600px;
    overflow-x: auto;
  }
  .ticket-header img.logo {
    width: 120px;
    display: block;
    margin-bottom: 0.5rem;
  }
  .ticket-header, .ticket-info, .ticket-footer, .ticket-total {
    margin-bottom: 1rem;
  }
  .ticket-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  .ticket-table th, .ticket-table td {
    border: 1px solid #ff2d8f99;
    padding: 0.4rem;
  }
  .ticket-footer {
    font-style: italic;
    color: #ff2d8faa;
    font-weight: 600;
  }
  /* Responsive */
  @media (max-width: 768px) {
    .container {
      width: 95%;
      padding: 1rem;
    }
    table, .ticket-table {
      font-size: 0.8rem;
    }
  }
</style>
</head>
<body>
  <div class="container">

    <!-- LOGIN -->
    <section id="loginSection" class="active">
      <h1>Control de Ventas - Login</h1>
      <form id="loginForm">
        <label for="usuario">Usuario:</label><br />
        <input type="text" id="usuario" name="usuario" required autocomplete="username" />
        <br />
        <label for="password">Contraseña:</label><br />
        <input type="password" id="password" name="password" required autocomplete="current-password" />
        <br />
        <label>Rol:</label><br />
        <select id="rol" name="rol" required>
          <option value="" disabled selected>Selecciona rol</option>
          <option value="administrador">Administrador</option>
          <option value="empleado">Empleado</option>
        </select>
        <br />
        <button type="submit">Ingresar</button>
        <p id="loginMsg" class="msg"></p>
      </form>
    </section>

    <!-- ADMIN -->
    <section id="adminSection">
      <h1>Panel Administrador</h1>
      <nav>
        <button id="btnSucursales">Sucursales</button>
        <button id="btnEmpleados">Empleados</button>
        <button id="btnInventario">Inventario</button>
        <button id="btnVentas">Reportes Ventas</button>
        <button id="btnMermas">Mermas</button>
        <button id="btnLogoutAdmin" style="margin-left:auto; background:#800040;">Cerrar Sesión</button>
      </nav>

      <div id="adminContent">
        <!-- Sucursales -->
        <div id="sucursalesSection" class="adminSubSection">
          <h2>Agregar Sucursal</h2>
          <form id="formAddSucursal">
            <input type="text" id="nombreSucursal" placeholder="Nombre sucursal" required />
            <button type="submit">Agregar</button>
          </form>
          <h3>Listado de Sucursales</h3>
          <ul id="listaSucursales"></ul>
        </div>

        <!-- Empleados -->
        <div id="empleadosSection" class="adminSubSection hidden">
          <h2>Agregar Empleado</h2>
          <form id="formAddEmpleado">
            <input type="text" id="empNombre" placeholder="Nombre completo" required />
            <input type="text" id="empUsuario" placeholder="Usuario" required />
            <input type="password" id="empPassword" placeholder="Contraseña" required />
            <select id="empRol" required>
              <option value="" disabled selected>Rol</option>
              <option value="administrador">Administrador</option>
              <option value="empleado">Empleado</option>
            </select>
            <select id="empSucursal" required>
              <option value="" disabled selected>Sucursal</option>
            </select>
            <button type="submit">Agregar</button>
          </form>
          <h3>Listado de Empleados</h3>
          <table>
            <thead><tr><th>Nombre</th><th>Usuario</th><th>Rol</th><th>Sucursal</th></tr></thead>
            <tbody id="tablaEmpleados"></tbody>
          </table>
        </div>

        <!-- Inventario -->
        <div id="inventarioSection" class="adminSubSection hidden">
          <h2>Agregar Producto al Inventario</h2>
          <form id="formAddProducto">
            <select id="invSucursal" required>
              <option value="" disabled selected>Sucursal</option>
            </select>
            <input type="text" id="invProducto" placeholder="Producto" required />
            <select id="invUnidad" required>
              <option value="" disabled selected>Unidad de medida</option>
              <option value="pieza">Pieza</option>
              <option value="kilo">Kilo</option>
              <option value="litro">Litro</option>
            </select>
            <input type="number" id="invCantidad" placeholder="Cantidad" min="0" step="any" required />
            <input type="number" id="invPrecioCompra" placeholder="Precio compra" min="0" step="any" required />
            <input type="number" id="invPrecioVenta" placeholder="Precio venta" min="0" step="any" required />
            <input type="number" id="invStockMin" placeholder="Stock mínimo (opcional)" min="0" step="any" />
            <button type="submit">Agregar / Actualizar</button>
          </form>

          <h3>Inventario Completo</h3>
          <table>
            <thead><tr><th>Sucursal</th><th>Producto</th><th>Unidad</th><th>Cantidad</th><th>Precio Compra</th><th>Precio Venta</th><th>Stock Mín</th></tr></thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>

        <!-- Reportes Ventas -->
        <div id="ventasSection" class="adminSubSection hidden">
          <h2>Reporte de Ventas Diarias</h2>
          <select id="ventasSucursalFiltro">
            <option value="" selected>-- Todas las sucursales --</option>
          </select>
          <button id="btnActualizarReporte">Actualizar Reporte</button>
          <div style="overflow-x:auto;">
            <table>
              <thead><tr><th>Sucursal</th><th>Empleado</th><th>Fecha</th><th>Cliente</th><th>Domicilio</th><th>Total (MXN)</th></tr></thead>
              <tbody id="tablaVentas"></tbody>
            </table>
          </div>
          <canvas id="graficaVentas" height="150" style="margin-top:1rem;"></canvas>
        </div>

        <!-- Mermas -->
        <div id="mermasSection" class="adminSubSection hidden">
          <h2>Registrar Merma</h2>
          <form id="formAddMerma">
            <select id="mermaSucursal" required>
              <option value="" disabled selected>Sucursal</option>
            </select>
            <input type="text" id="mermaProducto" placeholder="Producto" required />
            <input type="number" id="mermaCantidad" placeholder="Cantidad" min="0" step="any" required />
            <input type="text" id="mermaMotivo" placeholder="Motivo" required />
            <button type="submit">Registrar Merma</button>
          </form>
          <h3>Listado de Mermas</h3>
          <table>
            <thead><tr><th>Sucursal</th><th>Producto</th><th>Cantidad</th><th>Motivo</th><th>Fecha</th></tr></thead>
            <tbody id="tablaMermas"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- EMPLEADO -->
    <section id="employeeSection">
      <h1>Panel Empleado - Venta</h1>
      <button id="btnLogoutEmp" style="background:#800040; margin-bottom:1rem;">Cerrar Sesión</button>
      <form id="ventaForm">
        <label for="sucursalVenta">Sucursal:</label><br />
        <select id="sucursalVenta" required>
          <option value="" disabled selected>Selecciona sucursal</option>
        </select><br />

        <h3>Productos disponibles</h3>
        <table>
          <thead><tr><th>Producto</th><th>Unidad</th><th>Precio Venta</th><th>Cantidad a vender</th></tr></thead>
          <tbody id="productosDisponiblesBody"></tbody>
        </table>

        <h3>Productos en venta</h3>
        <table>
          <thead><tr><th>Producto</th><th>Cantidad</th><th>Precio Unitario</th><th>Total</th><th>Quitar</th></tr></thead>
          <tbody id="productosVentaBody"></tbody>
        </table>
        <p><strong>Total venta: </strong><span id="totalVenta">$0.00</span></p>

        <label for="nombreCliente">Nombre cliente (opcional):</label><br />
        <input type="text" id="nombreCliente" placeholder="Nombre cliente" /><br />
        <label for="domicilioCliente">Domicilio cliente (opcional):</label><br />
        <textarea id="domicilioCliente" placeholder="Domicilio cliente"></textarea><br />

        <button type="submit">Registrar Venta y Generar Ticket</button>
      </form>

      <div id="ticketSection">
        <h2>Ticket de Venta</h2>
        <div id="ticketContent"></div>
        <button id="btnCerrarTicket" style="margin-top:1rem;">Cerrar Ticket</button>
      </div>
    </section>
  </div>

  <!-- Librería Chart.js CDN para gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJcyqN4I9mP_fExdAZxCp2_09MClacw5F3Zvwh1OhbG1qlri_GiQz1Pl33-tQPQaYm/exec'; // Cambia esta URL por tu deployment de Apps Script

  // --- Variables globales ---
  let currentUser = null;
  let currentRole = null;

  // --- LOGIN ---
  const loginSection = document.getElementById('loginSection');
  const adminSection = document.getElementById('adminSection');
  const employeeSection = document.getElementById('employeeSection');

  const loginForm = document.getElementById('loginForm');
  const loginMsg = document.getElementById('loginMsg');

  loginForm.onsubmit = async e => {
    e.preventDefault();
    loginMsg.textContent = 'Validando...';

    const usuario = loginForm.usuario.value.trim();
    const password = loginForm.password.value.trim();
    const rol = loginForm.rol.value;

    if(!usuario || !password || !rol) {
      loginMsg.textContent = 'Completa todos los campos';
      return;
    }

    try {
      const res = await fetch(SCRIPT_URL + '?action=login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({usuario, password})
      });
      const data = await res.json();

      if(data.success && data.user) {
        if(data.user.rol !== rol) {
          loginMsg.textContent = 'Rol incorrecto para este usuario';
          return;
        }
        currentUser = data.user;
        currentRole = rol;
        loginMsg.textContent = '';
        loginSection.classList.remove('active');
        if(rol === 'administrador') {
          adminSection.classList.add('active');
          await cargarAdmin();
        } else {
          employeeSection.classList.add('active');
          await cargarEmpleado();
        }
      } else {
        loginMsg.textContent = 'Usuario o contraseña incorrectos';
      }
    } catch(err) {
      loginMsg.textContent = 'Error en conexión';
      console.error(err);
    }
  };

  // --- LOGOUT ---
  document.getElementById('btnLogoutAdmin').onclick = () => {
    logout();
  };
  document.getElementById('btnLogoutEmp').onclick = () => {
    logout();
  };
  function logout() {
    currentUser = null;
    currentRole = null;
    adminSection.classList.remove('active');
    employeeSection.classList.remove('active');
    loginSection.classList.add('active');
    loginForm.reset();
  }

  // --- ADMIN PANEL ---
  const btnSucursales = document.getElementById('btnSucursales');
  const btnEmpleados = document.getElementById('btnEmpleados');
  const btnInventario = document.getElementById('btnInventario');
  const btnVentas = document.getElementById('btnVentas');
  const btnMermas = document.getElementById('btnMermas');

  const sucursalesSection = document.getElementById('sucursalesSection');
  const empleadosSection = document.getElementById('empleadosSection');
  const inventarioSection = document.getElementById('inventarioSection');
  const ventasSection = document.getElementById('ventasSection');
  const mermasSection = document.getElementById('mermasSection');

  const adminSubSections = [sucursalesSection, empleadosSection, inventarioSection, ventasSection, mermasSection];

  function showAdminSection(section) {
    adminSubSections.forEach(s => s.classList.add('hidden'));
    section.classList.remove('hidden');
  }

  btnSucursales.onclick = () => showAdminSection(sucursalesSection);
  btnEmpleados.onclick = () => showAdminSection(empleadosSection);
  btnInventario.onclick = () => showAdminSection(inventarioSection);
  btnVentas.onclick = () => showAdminSection(ventasSection);
  btnMermas.onclick = () => showAdminSection(mermasSection);

  // --- CARGAR ADMIN ---
  async function cargarAdmin() {
    showAdminSection(sucursalesSection);
    await cargarSucursales();
    await cargarEmpleados();
    await cargarInventario();
    await cargarVentas();
    await cargarMermas();
  }

  // --- SUCURSALES ---
  const formAddSucursal = document.getElement
